<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Settings</title>
  <link rel="stylesheet" href="ethicom-style.css" />
  <script src="../utils/op-level.js"></script>
  <script src="ethicom-utils.js"></script>
  <script src="language-selector.js"></script>
  <script src="theme-manager.js"></script>
  <script src="accessibility.js"></script>
  <script src="slow-mode.js"></script>
  <script src="touch-features.js"></script>
  <script src="attention-seeker.js"></script>
  <script src="logo-background.js"></script>
  <script src="module-logo.js"></script>
</head>
<body>
  <a class="skip-link" href="#main_content">Skip to main content</a>
  <div id="op_background"></div>
  <header>
    <h1>Settings</h1>
  </header>
  <section class="hero">
    <p class="tagline">Ethik-Kompass für technologische Projekte</p>
  </section>
  <nav aria-label="Main navigation">
    <a href="../home.html">Home</a>
    <a href="../bewertung.html">Bewertung</a>
    <a href="settings.html" aria-current="page" class="icon-only" aria-label="Settings">⚙</a>
    <a href="../wings/ratings.html">Ratings</a>
    <a href="signup.html">Signup</a>
    <a href="genealogie.html">Genealogie</a>
      <a href="hermes.html">Hermes</a>
    <a href="../README.html" class="readme-link">README</a>
  </nav>
  <main id="main_content">
    <p class="note">Settings are saved locally. Some options apply after reload.</p>
    <div class="settings-grid">
    <details class="card">
      <summary>Language</summary>
      <div id="lang_selection">
        <label for="lang_select">Select:</label>
        <select id="lang_select"></select>
      </div>
    </details>
      <details class="card" id="theme_selection">
        <summary>Color Scheme</summary>
        <label for="theme_select">Scheme:</label>
        <select id="theme_select">
          <option value="tanna-dark">Dark Tanna</option>
          <option value="tanna">Tanna</option>
          <option value="transparent">Transparent</option>
          <option value="ocean">Sea Blue</option>
          <option value="desert">Desert</option>
          <option value="custom">Custom</option>
        </select>
        <button id="custom_theme_btn" style="display:none;margin-top:0.5em;" class="accent-button">Create Custom Scheme</button>
      </details>
    <button id="color_settings_btn" class="accent-button" type="button" onclick="openColorSettingsPopin()">Color Settings</button>
    <details class="card">
      <summary>Background</summary>
      <div id="background_settings">
        <div id="background_count">
          <label for="bg_fill_ratio">Tanna background fill: <span id="bg_fill_ratio_val">40</span>%</label>
          <input type="range" id="bg_fill_ratio" min="20" max="99" step="1" value="40" />
            <small class="note">Reload to apply.</small>
        </div>
        <div id="same_level_count" style="display:none;">
          <label for="bg_same_level_count">Your level Tannas: <span id="bg_same_level_val">1</span></label>
          <input type="range" id="bg_same_level_count" min="1" max="10" step="1" value="1" />
            <small class="note">Reload to apply.</small>
        </div>
        <div id="bg_collisions">
          <label><input type="checkbox" id="bg_enable_collisions" checked/> Enable Tanna collisions</label>
            <small class="note">Reload to apply.</small>
        </div>
        <div id="bg_symbol_hue_wrap">
          <label for="bg_symbol_hue">Tanna hue offset: <span id="bg_symbol_hue_val">0</span>&deg;</label>
          <input type="range" id="bg_symbol_hue" min="0" max="360" step="1" value="0" />
            <small class="note">Reload to apply.</small>
        </div>
      </div>
    </details>
    <details class="card">
      <summary>Foreground Transparency</summary>
      <div id="foreground_opacity">
        <label for="fg_opacity">Foreground transparency: <span id="fg_opacity_val">0</span>%</label>
        <input type="range" id="fg_opacity" min="0" max="80" step="1" value="0" />
      </div>
    </details>
    <details class="card">
      <summary>Touch Features</summary>
      <div id="touch_features">
        <label><input type="checkbox" id="touch_gestures"/> Enable gestures</label><br/>
        <label><input type="checkbox" id="touch_longpress"/> Enable quick menus</label><br/>
        <label><input type="checkbox" id="touch_drawing"/> Enable drawing</label><br/>
        <label><input type="checkbox" id="touch_bigbuttons"/> Larger buttons</label><br/>
        <label><input type="checkbox" id="touch_haptics"/> Haptic feedback</label>
      </div>
    </details>
    <details class="card">
      <summary>Attention Alerts</summary>
      <div id="attention_features">
        <label><input type="checkbox" id="attention_wiggle"/> Wiggle when idle</label><br/>
        <label><input type="checkbox" id="attention_beep"/> Beep when idle</label>
      </div>
    </details>
    <details class="card">
      <summary>Accessibility Setup</summary>
      <div id="access_setup"></div>
    </details>
    <details class="card">
      <summary>Repository</summary>
      <div id="repo_download">
        <a href="/download.zip" class="accent-button">Download .zip</a>
      </div>
    </details>
    <details class="card">
      <summary>Gatekeeper Token</summary>
      <button id="token_btn" class="accent-button" type="button">Generate Token</button>
      <p id="token_display" class="note"></p>
    </details>
    </div><!-- settings-grid -->
  </main>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      initLanguageDropdown('lang_select');
      function parseCol(v){
        v=(v||'').trim();
        if(v.startsWith('#')){
          if(v.length===4) v='#'+v[1]+v[1]+v[2]+v[2]+v[3]+v[3];
          const n=parseInt(v.slice(1),16);
          return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};
        }
        const m=v.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
        return m?{r:+m[1],g:+m[2],b:+m[3]}:{r:0,g:0,b:0};
      }
      function initColorSliders(){
        const wrap=document.getElementById('color_scheme');
        if(!wrap) return;
        const vars={
          '--highlight-text-color':'Highlight','--text-color':'Text','--header-text-color':'Header Text',
          '--nav-text-color':'Nav Text','--bg-color':'Background','--card-bg':'Card',
          '--header-bg':'Header BG','--nav-bg':'Nav BG','--card-alpha-bg':'Card Alpha',
          '--primary-color':'Primary','--accent-color':'Accent'
        };
        const textVars=new Set(['--text-color','--header-text-color','--nav-text-color','--highlight-text-color']);
        const stored=JSON.parse(localStorage.getItem('ethicom_colors')||'{}');
        wrap.innerHTML='';
        for(const [name,label] of Object.entries(vars)){
          const base=parseCol(stored[name]||getComputedStyle(document.documentElement).getPropertyValue(name));
          const b=document.createElement('div');
          const sample=textVars.has(name)?'Text':'';
          b.innerHTML=`<strong>${label}</strong><br>
          <label>R: <input type="range" min="0" max="255" value="${base.r}"> <span>${base.r}</span></label><br>
          <label>G: <input type="range" min="0" max="255" value="${base.g}"> <span>${base.g}</span></label><br>
          <label>B: <input type="range" min="0" max="255" value="${base.b}"> <span>${base.b}</span></label>
          <span class="color-preview${sample?' text-preview':''}">${sample}</span>`;
          const inputs=b.querySelectorAll('input');
          const spans=b.querySelectorAll('span');
          const preview=b.querySelector('.color-preview');
          function upd(){
            const r=+inputs[0].value,g=+inputs[1].value,bv=+inputs[2].value;
            spans[0].textContent=r;spans[1].textContent=g;spans[2].textContent=bv;
            const col=`rgb(${r},${g},${bv})`;
            document.documentElement.style.setProperty(name,col);
            stored[name]=col;
            localStorage.setItem('ethicom_colors',JSON.stringify(stored));
            if(preview){
              if(textVars.has(name)) preview.style.color=col; else preview.style.backgroundColor=col;
            }
          }
          inputs.forEach(i=>i.addEventListener('input',upd));
          wrap.appendChild(b); upd();
        }
      }
      initColorSliders();
      const s = window.touchSettings && window.touchSettings.state || {};
      const g = document.getElementById('touch_gestures');
      const h = document.getElementById('touch_haptics');
      const d = document.getElementById('touch_drawing');
      const b = document.getElementById('touch_bigbuttons');
      const l = document.getElementById('touch_longpress');
      if (g) g.checked = s.gestures; if (h) h.checked = s.haptics;
      if (d) d.checked = s.drawing; if (b) b.checked = s.bigButtons;
      if (l) l.checked = s.longPressMenu;
      if (g) g.addEventListener('change', e => touchSettings.toggleGestures(e.target.checked));
      if (h) h.addEventListener('change', e => touchSettings.toggleHaptics(e.target.checked));
      if (d) d.addEventListener('change', e => touchSettings.toggleDrawing(e.target.checked));
      if (b) b.addEventListener('change', e => touchSettings.toggleBigButtons(e.target.checked));
      if (l) l.addEventListener('change', e => touchSettings.toggleLongPressMenu(e.target.checked));

      const as = window.attentionSettings && window.attentionSettings.state || {};
      const aw = document.getElementById('attention_wiggle');
      const ab = document.getElementById('attention_beep');
      if (aw) aw.checked = as.wiggle; if (ab) ab.checked = as.beep;
      if (aw) aw.addEventListener('change', e => attentionSettings.toggleWiggle(e.target.checked));
      if (ab) ab.addEventListener('change', e => attentionSettings.toggleBeep(e.target.checked));

      const tr = document.getElementById('tanna_r');
      const tg = document.getElementById('tanna_g');
      const tb = document.getElementById('tanna_b');
      const trv = document.getElementById('tanna_r_val');
      const tgv = document.getElementById('tanna_g_val');
      const tbv = document.getElementById('tanna_b_val');
      const tp = document.getElementById('tanna_preview');
      const warn = document.getElementById('tanna_contrast');
      function lum(v){v/=255;return v<=0.03928?v/12.92:Math.pow((v+0.055)/1.055,2.4);}
      function contrast(c){const l1=0.2126*lum(c.r)+0.7152*lum(c.g)+0.0722*lum(c.b);const l2=0.2126*lum(34)+0.7152*lum(139)+0.0722*lum(34);return (Math.max(l1,l2)+0.05)/(Math.min(l1,l2)+0.05);}
      function upd(){
        const c={r:+tr.value,g:+tg.value,b:+tb.value};
        trv.textContent=c.r;
        tgv.textContent=c.g;
        tbv.textContent=c.b;
        localStorage.setItem('ethicom_tanna_color',JSON.stringify(c));
        if(document.body.classList.contains('theme-tanna') ||
           document.body.classList.contains('theme-tanna-dark')){
          const css=`rgb(${c.r},${c.g},${c.b})`;
          document.documentElement.style.setProperty('--primary-color',css);
          document.documentElement.style.setProperty('--accent-color',css);
          const h=`rgba(${Math.round(c.r*0.2)},${Math.round(c.g*0.2)},${Math.round(c.b*0.2)},0.9)`;
          const n=`rgba(${Math.round(c.r*0.3)},${Math.round(c.g*0.3)},${Math.round(c.b*0.3)},0.9)`;
          document.documentElement.style.setProperty('--header-bg',h);
          document.documentElement.style.setProperty('--nav-bg',n);
        }
        if(tp) tp.style.backgroundColor=`rgb(${c.r},${c.g},${c.b})`;
        warn.style.display=contrast(c)<2?'inline':'none';
      }
      if(tr&&tg&&tb){const s=JSON.parse(localStorage.getItem('ethicom_tanna_color')||'{"r":34,"g":139,"b":34}');tr.value=s.r;tg.value=s.g;tb.value=s.b;upd();[tr,tg,tb].forEach(el=>el.addEventListener('input',upd));}

      const slider = document.getElementById('bg_fill_ratio');
      const val = document.getElementById('bg_fill_ratio_val');
      if (slider && val) {
        const stored = parseInt(localStorage.getItem('ethicom_bg_fill') || '40', 10);
        slider.value = stored;
        val.textContent = stored;
        slider.addEventListener('input', e => val.textContent = e.target.value);
        slider.addEventListener('change', e => {
          localStorage.setItem('ethicom_bg_fill', e.target.value);
          alert('Reload the page to apply.');
        });
      }

      const sameWrap = document.getElementById('same_level_count');
      const sameSlider = document.getElementById('bg_same_level_count');
      const sameVal = document.getElementById('bg_same_level_val');
      const lvlNum = typeof getStoredOpLevel === 'function' ? opLevelToNumber(getStoredOpLevel()) : 0;
      if (sameWrap) sameWrap.style.display = lvlNum >= 1 ? 'block' : 'none';
      if (lvlNum >= 1 && sameSlider && sameVal) {
        const storedSame = parseInt(localStorage.getItem('ethicom_same_level_count') || '1', 10);
        const cur = Math.max(1, storedSame);
        sameSlider.value = cur;
        sameVal.textContent = cur;
        sameSlider.addEventListener('input', e => sameVal.textContent = e.target.value);
        sameSlider.addEventListener('change', e => {
          localStorage.setItem('ethicom_same_level_count', e.target.value);
          alert('Reload the page to apply.');
        });
      }

      const colChk = document.getElementById('bg_enable_collisions');
      if (colChk) {
        const storedCol = localStorage.getItem('ethicom_bg_collisions');
        colChk.checked = storedCol !== '0';
        colChk.addEventListener('change', e => {
          localStorage.setItem('ethicom_bg_collisions', e.target.checked ? '1' : '0');
          alert('Reload the page to apply.');
        });
      }

      const hueSlider = document.getElementById('bg_symbol_hue');
      const hueVal = document.getElementById('bg_symbol_hue_val');
      if (hueSlider && hueVal) {
        const storedHue = parseInt(localStorage.getItem('ethicom_bg_symbol_hue') || '0', 10);
        hueSlider.value = storedHue;
        hueVal.textContent = storedHue;
        hueSlider.addEventListener('input', e => hueVal.textContent = e.target.value);
        hueSlider.addEventListener('change', e => {
          localStorage.setItem('ethicom_bg_symbol_hue', e.target.value);
          alert('Reload the page to apply.');
        });
      }

      const txr = document.getElementById('text_r');
      const txg = document.getElementById('text_g');
      const txb = document.getElementById('text_b');
      const txrv = document.getElementById('text_r_val');
      const txgv = document.getElementById('text_g_val');
      const txbv = document.getElementById('text_b_val');
      const textPrev = document.getElementById('text_preview');
      function updText(){
        const c={r:+txr.value,g:+txg.value,b:+txb.value};
        txrv.textContent=c.r;
        txgv.textContent=c.g;
        txbv.textContent=c.b;
        document.documentElement.style.setProperty('--text-color',`rgb(${c.r},${c.g},${c.b})`);
        localStorage.setItem('ethicom_text_color',JSON.stringify(c));
        if(textPrev) textPrev.style.backgroundColor=`rgb(${c.r},${c.g},${c.b})`;
      }
      if(txr&&txg&&txb){
        let def;
        try{def=JSON.parse(localStorage.getItem('ethicom_text_color')||'null');}catch{}
        if(!def){
          const comp=getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
          const m=comp.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
          def=m?{r:+m[1],g:+m[2],b:+m[3]}:{r:224,g:224,b:224};
        }
        txr.value=def.r;txg.value=def.g;txb.value=def.b;
        updText();
        [txr,txg,txb].forEach(el=>el.addEventListener('input',updText));
      }

      const fgSlider = document.getElementById('fg_opacity');
      const fgVal = document.getElementById('fg_opacity_val');
      if (fgSlider && fgVal) {
        let storedFg = parseInt(localStorage.getItem('ethicom_fg_opacity') || '0', 10);
        if (storedFg > 80) storedFg = 80;
        fgSlider.value = storedFg;
        fgVal.textContent = storedFg;
        fgSlider.addEventListener('input', e => {
          fgVal.textContent = e.target.value;
          setForegroundOpacity(e.target.value);
        });
        fgSlider.addEventListener('change', e => {
          localStorage.setItem('ethicom_fg_opacity', e.target.value);
        });
      }

      const tokenBtn = document.getElementById('token_btn');
      const tokenDisplay = document.getElementById('token_display');
      if (tokenBtn && tokenDisplay) {
        tokenBtn.addEventListener('click', () => {
          fetch('/api/gatekeeper/token')
            .then(r => r.json())
            .then(d => {
              tokenDisplay.textContent = d.token;
              localStorage.setItem('gate_temp_token', JSON.stringify({ token: d.token, expires: Date.now() + d.expires_in * 1000 }));
            });
        });
      }
    });
  </script>
</body>
</html>
