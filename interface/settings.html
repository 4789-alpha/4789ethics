<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Settings</title>
  <link rel="stylesheet" href="ethicom-style.css">
<script src="bundle.js" defer></script>
  <script src="../utils/op-level.js"></script>
</head>
<body>
  <a class="skip-link" href="#main_content">Skip to main content</a>
  <div id="op_background"></div>
  <header>
    <h1>Settings</h1>
  </header>
  <div class="hero">
    <p class="tagline">Ethik-Kompass für technologische Projekte</p>
  </div>
  <nav aria-label="Main navigation">
    <a href="../index.html">Home</a>
    <a href="../bewertung.html">Bewertung</a>
    <a href="settings.html" aria-current="page" class="icon-only" aria-label="Settings">⚙</a>
    <a href="../wings/ratings.html">Ratings</a>
    <a href="signup.html">Signup</a>
      <a href="hermes.html">Hermes</a>
    <a href="../README.html" class="readme-link">README</a>
    <button id="side_menu" type="button" class="icon-only" aria-label="Menu">☰</button>
  </nav>
  <main id="main_content">
    <p class="note">Settings are saved locally. Some options apply after reload.</p>
    <div class="settings-grid">
    <details class="card">
      <summary>Language</summary>
      <div id="lang_selection">
        <label for="lang_select">Select:</label>
        <select id="lang_select"></select>
      </div>
    </details>
      <details class="card" id="theme_selection">
        <summary>Color Scheme</summary>
        <label for="theme_select">Scheme:</label>
        <select id="theme_select">
          <option value="dark">Dark</option>
          <option value="tanna-dark">Dark Tanna</option>
          <option value="tanna">Tanna</option>
          <option value="transparent">Transparent</option>
          <option value="ocean">Sea Blue</option>
          <option value="desert">Desert</option>
          <option value="accessible">Accessible</option>
          <option value="custom">Custom</option>
        </select>
        <button id="custom_theme_btn" style="display:none;margin-top:0.5em;" class="accent-button">Create Custom Scheme</button>
      </details>
    <details class="card" id="color_settings">
      <summary>Color Settings</summary>
      <div id="color_scheme"></div>
      <button id="color_settings_btn" class="accent-button" type="button" onclick="openColorSettingsPopin()">Adjust Colors</button>
      <button id="color_wizard_btn" class="accent-button" type="button" onclick="openColorSettingsWizard()">Color Wizard</button>
      <button id="color_cli_wizard_btn" class="accent-button" type="button" onclick="openColorSettingsWizardCLI()">Text Wizard</button>
    </details>
    <details class="card">
      <summary>Background</summary>
      <div id="background_settings">
        <div id="background_count">
          <label for="bg_fill_ratio">Tanna background fill: <span id="bg_fill_ratio_val">40</span>%</label>
          <input type="range" id="bg_fill_ratio" min="20" max="95" step="1" value="40" />
            <small class="note">Reload to apply.</small>
        </div>
        <div id="same_level_count" style="display:none;">
          <label for="bg_same_level_count">Your level Tannas: <span id="bg_same_level_val">1</span></label>
          <input type="range" id="bg_same_level_count" min="1" max="10" step="1" value="1" />
            <small class="note">Reload to apply.</small>
        </div>
        <div id="bg_low_motion_wrap">
          <label><input type="checkbox" id="bg_low_motion"/> Low motion background</label>
          <small class="note">Reload to apply.</small>
        </div>
        <div id="bg_symbol_hue_wrap">
          <label for="bg_symbol_hue">Tanna hue offset: <span id="bg_symbol_hue_val">0</span>&deg;</label>
          <input type="range" id="bg_symbol_hue" min="0" max="360" step="1" value="0" />
            <small class="note">Applies instantly.</small>
        </div>
        <div id="bg_symbol_size_wrap">
          <label for="bg_symbol_size">Tanna size: <span id="bg_symbol_size_val">100</span>%</label>
          <input type="range" id="bg_symbol_size" min="50" max="200" step="10" value="100" />
            <small class="note">Reload to apply.</small>
        </div>
        <div id="bg_damping_wrap">
          <label for="bg_damping">Tanna damping: <span id="bg_damping_val">1</span></label>
          <input type="range" id="bg_damping" min="0" max="1" step="0.05" value="1" />
            <small class="note">Reload to apply.</small>
        </div>
      </div>
    </details>
    <details class="card">
      <summary>Foreground Transparency</summary>
      <div id="foreground_opacity">
        <label for="fg_opacity">Foreground transparency: <span id="fg_opacity_val">0</span>%</label>
        <input type="range" id="fg_opacity" min="0" max="80" step="1" value="0" />
      </div>
    </details>
    <details class="card">
      <summary>Touch Features</summary>
      <div id="touch_features">
        <label><input type="checkbox" id="touch_gestures"/> Enable gestures</label><br/>
        <label><input type="checkbox" id="touch_longpress"/> Enable quick menus</label><br/>
        <label><input type="checkbox" id="touch_drawing"/> Enable drawing</label>
        <small class="note">Reload to apply.</small><br/>
        <label><input type="checkbox" id="touch_bigbuttons"/> Larger buttons</label><br/>
        <label><input type="checkbox" id="touch_haptics"/> Haptic feedback</label>
      </div>
    </details>
    <details class="card">
      <summary>Attention Alerts</summary>
      <div id="attention_features">
        <label><input type="checkbox" id="attention_wiggle"/> Wiggle when idle</label>
        <small class="note">Reload to apply.</small><br/>
        <label><input type="checkbox" id="attention_beep"/> Beep when idle</label>
        <small class="note">Reload to apply.</small>
     </div>
   </details>
    <details class="card">
      <summary>Accessibility Setup</summary>
      <div id="access_setup"></div>
    </details>
    <details class="card">
      <summary>Repository</summary>
      <div id="repo_download">
        <a href="/download.zip" class="accent-button">Download .zip</a>
        <a href="/tools/easy-start.js" class="accent-button">easy-start.js</a>
      </div>
    </details>
    <details class="card">
      <summary>Gatekeeper Token</summary>
      <button id="token_btn" class="accent-button" type="button">Generate Token</button>
      <p id="token_display" class="note"></p>
    </details>
    </div><!-- settings-grid -->
  </main>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      checkLanguageSetup();
      initLanguageDropdown('lang_select');
      function initColorSliders(){
        const wrap=document.getElementById('color_scheme');
        if(!wrap) return;
        const vars={
          '--highlight-text-color':'Highlight Text','--text-color':'Text','--header-text-color':'Header Text',
          '--nav-text-color':'Nav Text','--bg-color':'Background','--card-bg':'Card',
          '--header-bg':'Header BG','--nav-bg':'Nav BG','--card-alpha-bg':'Card Alpha',
          '--primary-color':'Primary','--accent-color':'Accent'
        };
        const textVars=new Set(['--highlight-text-color','--text-color','--header-text-color','--nav-text-color']);
        const stored=JSON.parse(localStorage.getItem('ethicom_colors')||'{}');
        wrap.innerHTML='';
        for(const [name,label] of Object.entries(vars)){
          const base=parseColor(stored[name]||getComputedStyle(document.documentElement).getPropertyValue(name));
          const b=document.createElement('div');
          const sample=textVars.has(name)?'Text':'';
          b.innerHTML=`<strong>${label}</strong><br>
          <label>R: <input type="range" min="0" max="255" value="${base.r}"> <span>${base.r}</span></label><br>
          <label>G: <input type="range" min="0" max="255" value="${base.g}"> <span>${base.g}</span></label><br>
          <label>B: <input type="range" min="0" max="255" value="${base.b}"> <span>${base.b}</span></label>
          <span class="color-preview${sample?' text-preview':''}">${sample}</span>`;
          const inputs=b.querySelectorAll('input');
          const spans=b.querySelectorAll('span');
          const preview=b.querySelector('.color-preview');
          function upd(){
            const r=+inputs[0].value,g=+inputs[1].value,bv=+inputs[2].value;
            spans[0].textContent=r;spans[1].textContent=g;spans[2].textContent=bv;
            const col=`rgb(${r},${g},${bv})`;
            document.documentElement.style.setProperty(name,col);
            stored[name]=col;
            localStorage.setItem('ethicom_colors',JSON.stringify(stored));
            if(preview){
              if(textVars.has(name)) preview.style.color=col; else preview.style.backgroundColor=col;
            }
          }
          inputs.forEach(i=>i.addEventListener('input',upd));
          wrap.appendChild(b); upd();
        }
      }
      initColorSliders();
      const s = window.touchSettings && window.touchSettings.state || {};
      const g = document.getElementById('touch_gestures');
      const h = document.getElementById('touch_haptics');
      const d = document.getElementById('touch_drawing');
      const b = document.getElementById('touch_bigbuttons');
      const l = document.getElementById('touch_longpress');
      if (g) g.checked = s.gestures; if (h) h.checked = s.haptics;
      if (d) d.checked = s.drawing; if (b) b.checked = s.bigButtons;
      if (l) l.checked = s.longPressMenu;
      if (g) g.addEventListener('change', e => touchSettings.toggleGestures(e.target.checked));
      if (h) h.addEventListener('change', e => touchSettings.toggleHaptics(e.target.checked));
      if (d) d.addEventListener('change', e => touchSettings.toggleDrawing(e.target.checked));
      if (b) b.addEventListener('change', e => touchSettings.toggleBigButtons(e.target.checked));
      if (l) l.addEventListener('change', e => touchSettings.toggleLongPressMenu(e.target.checked));

      const as = window.attentionSettings && window.attentionSettings.state || {};
      const aw = document.getElementById('attention_wiggle');
      const ab = document.getElementById('attention_beep');
      if (aw) aw.checked = as.wiggle; if (ab) ab.checked = as.beep;
      if (aw) aw.addEventListener('change', e => attentionSettings.toggleWiggle(e.target.checked));
      if (ab) ab.addEventListener('change', e => attentionSettings.toggleBeep(e.target.checked));


      const slider = document.getElementById('bg_fill_ratio');
      const val = document.getElementById('bg_fill_ratio_val');
      if (slider && val) {
        let stored = parseInt(localStorage.getItem('ethicom_bg_fill') || '40', 10);
        stored = Math.min(stored, parseInt(slider.max, 10));
        slider.value = stored;
        val.textContent = stored;
        slider.addEventListener('input', e => val.textContent = e.target.value);
        slider.addEventListener('change', e => {
          localStorage.setItem('ethicom_bg_fill', e.target.value);
          alert('Reload the page to apply.');
        });
      }

      const sameWrap = document.getElementById('same_level_count');
      const sameSlider = document.getElementById('bg_same_level_count');
      const sameVal = document.getElementById('bg_same_level_val');
      const lvlNum = typeof getStoredOpLevel === 'function' ? opLevelToNumber(getStoredOpLevel()) : 0;
      const themeWrap = document.getElementById('theme_selection');
      const colorWrap = document.getElementById('color_settings');
      if (lvlNum < 3) {
        if (themeWrap) themeWrap.style.display = 'none';
        if (colorWrap) colorWrap.style.display = 'none';
      }
      if (sameWrap) sameWrap.style.display = lvlNum >= 1 ? 'block' : 'none';
      if (lvlNum >= 1 && sameSlider && sameVal) {
        const storedSame = parseInt(localStorage.getItem('ethicom_same_level_count') || '1', 10);
        const cur = Math.max(1, storedSame);
        sameSlider.value = cur;
        sameVal.textContent = cur;
        sameSlider.addEventListener('input', e => sameVal.textContent = e.target.value);
        sameSlider.addEventListener('change', e => {
          localStorage.setItem('ethicom_same_level_count', e.target.value);
          alert('Reload the page to apply.');
        });
      }


      const hueSlider = document.getElementById('bg_symbol_hue');
      const hueVal = document.getElementById('bg_symbol_hue_val');
      if (hueSlider && hueVal) {
        const storedHue = parseInt(localStorage.getItem('ethicom_bg_symbol_hue') || '0', 10);
        hueSlider.value = storedHue;
        hueVal.textContent = storedHue;
        hueSlider.addEventListener('input', e => hueVal.textContent = e.target.value);
        hueSlider.addEventListener('change', e => {
          localStorage.setItem('ethicom_bg_symbol_hue', e.target.value);
          document.dispatchEvent(new CustomEvent('themeChanged'));
        });
      }

      const sizeSlider = document.getElementById('bg_symbol_size');
      const sizeVal = document.getElementById('bg_symbol_size_val');
        if (sizeSlider && sizeVal) {
          const storedSize = parseInt(localStorage.getItem('ethicom_bg_symbol_size') || '100', 10);
          sizeSlider.value = storedSize;
          sizeVal.textContent = storedSize;
          sizeSlider.addEventListener('input', e => sizeVal.textContent = e.target.value);
          sizeSlider.addEventListener('change', e => {
            localStorage.setItem('ethicom_bg_symbol_size', e.target.value);
            alert('Reload the page to apply.');
          });
        }

      const dampSlider = document.getElementById('bg_damping');
      const dampVal = document.getElementById('bg_damping_val');
        if (dampSlider && dampVal) {
          const storedDamp = parseFloat(localStorage.getItem('ethicom_bg_restitution') || '1');
          dampSlider.value = storedDamp;
          dampVal.textContent = storedDamp;
          dampSlider.addEventListener('input', e => dampVal.textContent = e.target.value);
          dampSlider.addEventListener('change', e => {
            localStorage.setItem('ethicom_bg_restitution', e.target.value);
            alert('Reload the page to apply.');
          });
        }
        const lowMotionChk = document.getElementById('bg_low_motion');
        if (lowMotionChk) {
          lowMotionChk.checked = localStorage.getItem('ethicom_bg_low_motion') === 'true';
          lowMotionChk.addEventListener('change', e => {
            localStorage.setItem('ethicom_bg_low_motion', e.target.checked ? 'true' : 'false');
          });
      const fgSlider = document.getElementById('fg_opacity');
      const fgVal = document.getElementById('fg_opacity_val');
      if (fgSlider && fgVal) {
        let storedFg = parseInt(localStorage.getItem('ethicom_fg_opacity') || '0', 10);
        if (storedFg > 80) storedFg = 80;
        fgSlider.value = storedFg;
        fgVal.textContent = storedFg;
        fgSlider.addEventListener('input', e => {
          fgVal.textContent = e.target.value;
          setForegroundOpacity(e.target.value);
        });
        fgSlider.addEventListener('change', e => {
          localStorage.setItem('ethicom_fg_opacity', e.target.value);
        });
      }

      const tokenBtn = document.getElementById('token_btn');
      const tokenDisplay = document.getElementById('token_display');
      if (tokenBtn && tokenDisplay) {
        tokenBtn.addEventListener('click', () => {
          fetch('/api/gatekeeper/token')
            .then(r => r.json())
            .then(d => {
              tokenDisplay.textContent = d.token;
              localStorage.setItem('gate_temp_token', JSON.stringify({ token: d.token, expires: Date.now() + d.expires_in * 1000 }));
            })
            .catch(() => {
              tokenDisplay.textContent = 'Token request failed. Please check your connection.';
            });
        });
      }

      const all = document.querySelectorAll('.settings-grid details');
      all.forEach(det => {
        det.addEventListener('toggle', () => {
          if (det.open) {
            all.forEach(other => { if (other !== det) other.open = false; });
          }
        });
      });
      initSideDrop('nav-menu.html');
      const menu = document.getElementById('side_menu');
      if (menu) menu.addEventListener('click', e => { e.preventDefault(); toggleSideDrop(); });
    });
  </script>
  <div id="side_drop"></div>
</body>
</html>
